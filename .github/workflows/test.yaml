name: Test

on:
  # Allows for manual triggering through api
  workflow_dispatch:

defaults:
    run:
      shell: bash

jobs:
  merge:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.important.outputs.status }}
    steps:

      - name: Git checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: '0'

      - name: git
        id: git-setup
        run: |
          git --version
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git status
          LAST_STAGING_TS=$(git log -n 1 --pretty=format:"%h%x09%ct%x09%s" origin/staging | awk '{print $2}')
          COMMITS="$(git log --pretty=format:'%h%x09%cI%x09%s' --since=format:ct:$LAST_STAGING_TS origin/main)"
          COMMITS_E="${COMMITS//$'\n'/'%0A'}"
          echo "::set-output name=commits::$COMMITS_E"
          echo "::set-output name=commits_old::$COMMITS_E"
          echo "COMMITS_NEW<<EOF" >> $GITHUB_ENV
          echo $COMMITS_E >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: important step
        id: important
        if: ${{ steps.git-setup.outputs.commits != '' }}
        env:
          COMMITS_OLD: ${{ steps.git-setup.outputs.commits_old }}
        run: |
          echo "This ran"
          echo "old $COMMITS_OLD"
          echo "new $COMMITS_NEW"
          echo "status=good" >> $GITHUB_OUTPUT
          git checkout staging
          git branch merge/staging
          git checkout main
          git merge -m "Merge branch 'merge/staging' into main" -s ours merge/staging
          git checkout merge/staging
          git merge --commit main
          git checkout staging
          git checkout -b staging_new
          git merge --squash merge/staging
          git commit -m "Automated release candidate NEW" -m "$COMMITS_NEW"
          git log -n 1
          git checkout staging
          git merge --squash merge/staging
          git commit -m "Automated release candidate OLD" -m "$COMMITS_OLD"
          git log -n 1

      - name: log step
        id: log
        if: ${{ steps.git-setup.outputs.commits != '' }}
        env:
          COMMITS_OLD: ${{ steps.git-setup.outputs.commits_old }}
        run: |
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "OLD" >> $GITHUB_STEP_SUMMARY
          echo "$COMMITS_OLD" >> $GITHUB_STEP_SUMMARY
          echo "NEW" >> $GITHUB_STEP_SUMMARY
          echo "$COMMITS_NEW" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: merge
    runs-on: ubuntu-latest
    if: ${{ needs.merge.outputs.status == 'good' }}

    steps:
      - name: do something
        run: |
          echo "deploying..."
